{% extends 'webapp/base.html' %}

{% block title %}Property Map - Real Estate Site{% endblock %}

{% block content %}
<div class="container-fluid my-3">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Filter Properties on Map</h5>
                </div>
                <div class="card-body">
                    <form method="GET" id="map-filters">
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" name="status" id="map-status-filter">
                                <option value="">All Status</option>
                                {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="type" class="form-label">Property Type</label>
                            <select class="form-select" name="type" id="map-type-filter">
                                <option value="">All Types</option>
                                {% for value, label in property_types %}
                                <option value="{{ value }}" {% if request.GET.type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="{% url 'property_map' %}" class="btn btn-secondary">Clear</a>
                    </form>
                    
                    <hr>
                    
                    <div class="mb-2">
                        <strong>Properties on Map: <span id="property-count">{{ properties|length }}</span></strong>
                    </div>
                    
                    <div class="legend">
                        <h6>Legend:</h6>
                        <div class="d-flex align-items-center mb-1">
                            <div style="width: 15px; height: 15px; background-color: #28a745; margin-right: 8px; border-radius: 3px;"></div>
                            <small>For Sale</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <div style="width: 15px; height: 15px; background-color: #007bff; margin-right: 8px; border-radius: 3px;"></div>
                            <small>For Rent</small>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <div style="width: 15px; height: 15px; background-color: #dc3545; margin-right: 8px; border-radius: 3px;"></div>
                            <small>Sold</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div style="width: 15px; height: 15px; background-color: #fd7e14; margin-right: 8px; border-radius: 3px;"></div>
                            <small>Rented</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Properties Map</h5>
                    <small class="text-muted">{{ properties|length }} properties found</small>
                </div>
                <div class="card-body p-0">
                    <div id="property-map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Property Detail Modal -->
<div class="modal fade" id="propertyModal" tabindex="-1" aria-labelledby="propertyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="propertyModalLabel">Property Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Bishkek coordinates as default center
const BISHKEK_COORDS = [42.8746, 74.5698];

let propertyMap = null;
let mapMarkers = [];

// Initialize the map when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
});

function initializeMap() {
    console.log('Initializing property map...');
    
    // Create map centered on Bishkek
    propertyMap = L.map('property-map').setView(BISHKEK_COORDS, 12);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(propertyMap);
    
    // Load property markers
    loadPropertyMarkers();
}

function loadPropertyMarkers() {
    // Clear existing markers
    mapMarkers.forEach(marker => propertyMap.removeLayer(marker));
    mapMarkers = [];
    
    // Properties data from Django
    const properties = {{ properties|safe|default:"[]" }};
    
    if (properties.length === 0) {
        console.log('No properties to display on map');
        return;
    }
    
    // Add markers for each property
    properties.forEach((property, index) => {
        let lat = property.latitude ? parseFloat(property.latitude) : BISHKEK_COORDS[0];
        let lng = property.longitude ? parseFloat(property.longitude) : BISHKEK_COORDS[1];
        
        // Add small variation if all properties have same coordinates
        if (properties.every(p => p.latitude === property.latitude)) {
            lat += (index * 0.01); // Add ~1km offset for each property
            lng += (index * 0.01);
        }
        
        // Create marker with different colors based on status
        const markerColor = getMarkerColor(property.status);
        
        // Create colored marker icon
        const markerIcon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        const marker = L.marker([lat, lng], { icon: markerIcon }).addTo(propertyMap);
        
        // Add popup with property info
        marker.bindPopup(`
            <div style="min-width: 200px;">
                <h6>${property.title}</h6>
                <p class="mb-1"><strong>$${Number(property.price).toLocaleString()}</strong></p>
                <p class="mb-1">${getStatusDisplay(property.status)} | ${getTypeDisplay(property.property_type)}</p>
                <p class="mb-1"><i class="fas fa-bed"></i> ${property.bedrooms} beds | <i class="fas fa-bath"></i> ${property.bathrooms} baths</p>
                <p class="mb-2"><i class="fas fa-map-marker-alt"></i> ${property.city}, ${property.state}</p>
                <button class="btn btn-primary btn-sm" onclick="showPropertyDetail('${property.id}')">View Details</button>
            </div>
        `);
        
        mapMarkers.push(marker);
    });
    
    // If we have markers, fit map to show all of them
    if (mapMarkers.length > 0) {
        const group = new L.featureGroup(mapMarkers);
        propertyMap.fitBounds(group.getBounds().pad(0.1));
        console.log('Map centered on', mapMarkers.length, 'properties');
    }
}

// Get marker color based on property status
function getMarkerColor(status) {
    const colorMap = {
        'sale': '#28a745',
        'rent': '#007bff',
        'sold': '#dc3545',
        'rented': '#fd7e14'
    };
    return colorMap[status] || '#6c757d';
}

// Helper functions for display
function getStatusDisplay(status) {
    const statusMap = {
        'sale': 'For Sale',
        'rent': 'For Rent',
        'sold': 'Sold',
        'rented': 'Rented'
    };
    return statusMap[status] || status;
}

function getTypeDisplay(type) {
    const typeMap = {
        'house': 'House',
        'apartment': 'Apartment',
        'condo': 'Condo',
        'townhouse': 'Townhouse',
        'land': 'Land'
    };
    return typeMap[type] || type;
}

// Show property detail in modal
async function showPropertyDetail(propertyId) {
    try {
        const response = await fetch(`/api/properties/${propertyId}/`);
        const property = await response.json();
        
        document.getElementById('propertyModalLabel').textContent = property.title;
        document.getElementById('modalBody').innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    ${property.image 
                        ? `<img src="${property.image}" class="img-fluid mb-3" alt="${property.title}">`
                        : `<div class="bg-light d-flex align-items-center justify-content-center mb-3" style="height: 200px;"><i class="fas fa-home fa-5x text-muted"></i></div>`
                    }
                    <p>${property.description}</p>
                </div>
                <div class="col-md-4">
                    <table class="table table-sm">
                        <tbody>
                            <tr><td><strong>Price:</strong></td><td class="text-primary h5">$${Number(property.price).toLocaleString()}</td></tr>
                            <tr><td><strong>Type:</strong></td><td>${getTypeDisplay(property.property_type)}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-secondary">${getStatusDisplay(property.status)}</span></td></tr>
                            <tr><td><strong>Bedrooms:</strong></td><td><i class="fas fa-bed"></i> ${property.bedrooms}</td></tr>
                            <tr><td><strong>Bathrooms:</strong></td><td><i class="fas fa-bath"></i> ${property.bathrooms}</td></tr>
                            <tr><td><strong>Area:</strong></td><td><i class="fas fa-ruler-combined"></i> ${property.area} sq ft</td></tr>
                            <tr><td><strong>Address:</strong></td><td>${property.address}</td></tr>
                            <tr><td><strong>City:</strong></td><td>${property.city}</td></tr>
                            <tr><td><strong>State:</strong></td><td>${property.state}</td></tr>
                            <tr><td><strong>ZIP:</strong></td><td>${property.zip_code}</td></tr>
                        </tbody>
                    </table>
                    <div class="mt-3">
                        <a href="/property/${property.id}/" class="btn btn-primary">View Full Details</a>
                    </div>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('propertyModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading property detail:', error);
        alert('Error loading property details');
    }
}

// Convert Django template data to JavaScript
const propertiesData = [
    {% for property in properties %}
    {
        id: "{{ property.id }}",
        title: "{{ property.title|escapejs }}",
        description: "{{ property.description|escapejs }}",
        property_type: "{{ property.property_type }}",
        status: "{{ property.status }}",
        price: {{ property.price }},
        bedrooms: {{ property.bedrooms }},
        bathrooms: {{ property.bathrooms }},
        area: {{ property.area }},
        address: "{{ property.address|escapejs }}",
        city: "{{ property.city|escapejs }}",
        state: "{{ property.state|escapejs }}",
        zip_code: "{{ property.zip_code }}",
        latitude: {{ property.latitude|default:"null" }},
        longitude: {{ property.longitude|default:"null" }},
        image: "{{ property.image|default:"" }}",
        featured: {{ property.featured|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Override the properties variable for the JavaScript functions
window.onload = function() {
    // Make properties data available globally
    window.properties = propertiesData;
};
</script>
{% endblock %}